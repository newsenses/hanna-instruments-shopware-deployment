FROM php:8.2-apache

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    zip \
    unzip \
    curl \
    libzip-dev \
    libpng-dev \
    libjpeg-dev \
    libfreetype6-dev \
    libicu-dev \
    && docker-php-ext-configure gd --with-freetype --with-jpeg \
    && docker-php-ext-install -j$(nproc) gd zip pdo pdo_mysql intl \
    && rm -rf /var/lib/apt/lists/*

# Install Composer
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

# Set working directory
WORKDIR /var/www/html

# Copy Shopware files
COPY shopware-files/ /var/www/html/
COPY shopware-database.sql /var/www/html/
COPY entrypoint.sh /usr/local/bin/entrypoint.sh

# Skip composer install since we have a complete installation
# RUN composer install --no-dev --optimize-autoloader

# Skip MySQL client install - we'll use PHP to connect to database
# RUN apt-get update && apt-get install -y mariadb-client && rm -rf /var/lib/apt/lists/*

# Set permissions
RUN mkdir -p /var/www/html/var \
    && chmod +x /usr/local/bin/entrypoint.sh \
    && chown -R www-data:www-data /var/www/html

# Configure Apache (nur HTTP f√ºr Debugging)
RUN sed -i 's|DocumentRoot /var/www/html|DocumentRoot /var/www/html/public|g' /etc/apache2/sites-available/000-default.conf \
    && a2enmod rewrite

# Create self-signed certificate
RUN openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
    -keyout /etc/ssl/private/apache-selfsigned.key \
    -out /etc/ssl/certs/apache-selfsigned.crt \
    -subj '/C=CH/ST=Switzerland/L=Zurich/O=Hanna Instruments/CN=hannainst.de'

# Configure SSL VirtualHost
RUN echo '<VirtualHost *:443>' > /etc/apache2/sites-available/hannainst-ssl.conf \
    && echo '    ServerName hannainst.de' >> /etc/apache2/sites-available/hannainst-ssl.conf \
    && echo '    ServerAlias hannainst.ch' >> /etc/apache2/sites-available/hannainst-ssl.conf \
    && echo '    DocumentRoot /var/www/html/public' >> /etc/apache2/sites-available/hannainst-ssl.conf \
    && echo '    SSLEngine on' >> /etc/apache2/sites-available/hannainst-ssl.conf \
    && echo '    SSLCertificateFile /etc/ssl/certs/apache-selfsigned.crt' >> /etc/apache2/sites-available/hannainst-ssl.conf \
    && echo '    SSLCertificateKeyFile /etc/ssl/private/apache-selfsigned.key' >> /etc/apache2/sites-available/hannainst-ssl.conf \
    && echo '</VirtualHost>' >> /etc/apache2/sites-available/hannainst-ssl.conf \
    && a2ensite hannainst-ssl

# Set PHP memory limit
RUN echo 'memory_limit = 512M' > /usr/local/etc/php/conf.d/memory-limit.ini

EXPOSE 80

# Einfacher Start wie bei Spiegsamap
CMD ["/usr/local/bin/entrypoint.sh"]
