name: Hanna Instruments - Database Deployment to Mittwald

on:
  push:
    branches: [main]
    paths:
      - 'shopware-database-deployment/**'
      - 'configs/**'
      - '.github/workflows/mittwald-deploy.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Prepare Database-only deployment
      run: |
        echo "ðŸ“¦ Bereite Datenbank-Deployment fÃ¼r Mittwald vor..."
        
        # Erstelle Deployment-Verzeichnis
        mkdir -p mittwald-deployment
        
        # Kopiere das bereits erstellte Datenbank-Deployment-Paket
        cp -r shopware-database-deployment/* mittwald-deployment/
        
        echo "âœ… Datenbank-Deployment vorbereitet"
        
    - name: Upload deployment package
      uses: actions/upload-artifact@v4
      with:
        name: mittwald-deployment-package
        path: mittwald-deployment/
        retention-days: 30
        
    - name: Deploy to Mittwald Studio
      run: |
        echo "ðŸš€ Deploye zu Mittwald Studio..."
        
        # Entferne mÃ¶gliche Newlines aus der Stack-ID
        STACK_ID=$(echo "${{ secrets.MITTWALD_STACK_ID }}" | tr -d '\n\r')
        echo "Bereinigte Stack-ID: $STACK_ID"
        
        # Verwende die Mittwald API direkt
        curl -X POST \
          -H "Authorization: Bearer ${{ secrets.MITTWALD_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d "{
            \"stackId\": \"$STACK_ID\",
            \"stackFile\": \"$(cat configs/stack.yaml | base64 -w 0)\"
          }" \
          https://api.mittwald.de/v2/stacks/$STACK_ID/deploy
        
        echo "âœ… Datenbank-Container erfolgreich zu Mittwald deployed!"
        echo "ðŸ“‹ Container verfÃ¼gbar:"
        echo "- MariaDB: Port 3306"
        echo "- phpMyAdmin: Port 8080"